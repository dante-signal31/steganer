################################
# GENERAL CONFIGURATION
################################
language: rust
rust:
#  - stable
  - nightly
matrix:
#  allow_failures:
#    # I'm working with nightly, but is nice to realize when stable works too.
#    - rust: stable
  fast_finish: true
# Cache your dependencies so they are only recompiled if they or the compiler were upgraded
cache: cargo

################################
# BRANCH FILTER
################################
branches:
  only:
  - staging

################################
# RESULT NOTIFICATIONS
################################
notifications:
  recipients:
    - dante.signal31@gmail.com
  on_sucess: always
  on_failure: always

################################
# TESTING
################################
before_script:
  - cargo update
script:
  - echo "Starting tests..."
  - cargo test --verbose
  - echo "Tests done."

################################
# DEPLOYMENT
################################
jobs:
  include:
    # Update master branch.
    - stage: Branch merge to production branch
      python: 3.6
      env:
        - PYTHONPATH="${PYTHONPATH}:${TRAVIS_BUILD_DIR}"
      if: branch = staging
      script:
        - echo "Merging staging branch with master..."
        - python3 ci_scripts/merge_with_production
        - echo "Merge done."
    # Upload packages to crates.io
    - stage: Crates.io deployment
      script:
        - echo "Deploying to crates.io..."
        - git fetch --all
        - git checkout master
        - git pull origin master
        - cargo login $CARGO_TOKEN
        - cargo publish
        - echo "Crates.io deployment done."
    # Build python module an upload it to Pypi
    - stage: Python module building
      script:
        - echo "Deploying python module to Pypi."
        - pip install pyo3-pack cffi
        - pyo3-pack publish -b cffi -u $PYPI_USERNAME -p $PYPI_PASSWORD
        - echo "Python module deployed."
